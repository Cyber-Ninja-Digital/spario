
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-storage.js"></script>

<script>
  const firebaseConfig = {
     databaseURL: "https://crmgodelta-default-rtdb.europe-west1.firebasedatabase.app",
     apiKey: "AIzaSyBHXIuwuPviUaOUlpzHGHgo3Qh5BxvyOQY",
     authDomain: "crmgodelta.firebaseapp.com",
     projectId: "crmgodelta",
     storageBucket: "crmgodelta.appspot.com",
     messagingSenderId: "895480844926",
     appId: "1:895480844926:web:bcc1b4f17cf8a5ab4f3e2f",
     measurementId: "G-DQMX104TNF",
  };

  firebase.initializeApp(firebaseConfig);
  console.log(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const firestoreDb = db; // используйте уже созданный экземпляр
  const realtimeDb = firebase.database();

  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

  function loginUser(email, password) {
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("Пользователь вошел в систему:", userCredential.user);
            console.log("User UID:", userCredential.user.uid);
        })
        .catch((error) => {
            console.error("Ошибка входа:", error);
            console.error("Error code:", error.code);
            console.error("Error message:", error.message);
        });
}


  auth.onAuthStateChanged(user => {
    if (user) {
      console.log('User signed in:', user);
    } else {
      console.log('Пользователь вышел');
    }
  });

window.addEventListener('DOMContentLoaded', (event) => {
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            console.log('Email:', email);
            console.log('Password:', password);
            loginUser(email, password);
        });
    }

    const logoutButton = document.getElementById("logout-button");
    if (logoutButton) {
        logoutButton.onclick = function() {
            auth.signOut().then(() => {
                console.log("User signed out successfully.");
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        };
    }
});
function formatNumber(number, digits = 2) {
  if (typeof number === "number") {
    return parseFloat(number.toFixed(digits));
  } else {
    return number;  // если это не число, просто вернуть исходное значение
  }
}
</script>
<table id="rent-cars-table">
    <thead>
        <tr>
            <th>Marka</th>
            <th>Model</th>
            <th>Numer</th>
            <th>Wynajem na tydzień</th>
            <th>Komentarze</th>
            <th>Status</th>
            <th>Przypisany Kierowca</th>
            <th>Zmień kierowcę</th>
            <th>Działania</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<script>
    async function signUpUser(email, password, firstName, lastName, phoneNumber) {
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const uid = userCredential.user.uid;
    
        const driverId = createDriverId(firstName, lastName);
    
        // Check if the user exists already
        const docSnapshot = await db.collection('users').doc(uid).get();
    
        if (!docSnapshot.exists) {
          // Add role to the user
          await db.collection('users').doc(uid).set({
            email: email,
            firstName: firstName,
            lastName: lastName,
            driverId: driverId,
            phoneNumber: phoneNumber,
            role: 'user'  // Add the role field
          });
    
          // Send email verification
          await userCredential.user.sendEmailVerification();
    
          document.getElementById('message').textContent = "Zarejestrowano pomyślnie! Przekierowanie na stronę logowania...";
          setTimeout(function() { window.location.href = '/log-in'; }, 3000);
        } else {
          document.getElementById('message').textContent = "Już jesteś zarejestrowany! Przekierowanie na stronę logowania...";
          setTimeout(function() { window.location.href = '/log-in'; }, 3000);
        }
    
      } catch (error) {
        console.error('Error signing up:', error);
        document.getElementById('message').textContent = "Błąd podczas rejestracji: " + error.message;
      }
    }
    
    function createDriverId(firstName, lastName) {

const polishToEnglish = { 'ą': 'a', 'ć': 'c', 'ę': 'e', 'ł': 'l', 'ń': 'n', 'ó': 'o', 'ś': 's', 'ź': 'z', 'ż': 'z', 'Ą': 'A', 'Ć': 'C', 'Ę': 'E', 'Ł': 'L', 'Ń': 'N', 'Ó': 'O', 'Ś': 'S', 'Ź': 'Z', 'Ż': 'Z' };

let driverId = `${firstName} ${lastName}`.replace(/[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, char => polishToEnglish[char]);

driverId = driverId.replace(/\s+/g, ' ').trim().toLowerCase();

driverId = driverId.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

return driverId;
}

    
document.getElementById('signup-form').addEventListener('submit', (event) => {
  event.preventDefault();
  const firstName = document.getElementById('first-name').value;
  const lastName = document.getElementById('last-name').value;
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;
  const phoneNumber = document.getElementById('phone-number').value; 
  signUpUser(email, password, firstName, lastName, phoneNumber); 
  

});
    
document.getElementById('google-signup-button').addEventListener('click', function () {
    var provider = new firebase.auth.GoogleAuthProvider();

    firebase.auth().signInWithPopup(provider)
      .then(async (result) => {
        var user = result.user;

        const nameParts = user.displayName.split(' ');
        const firstName = nameParts[0];
        const lastName = nameParts.length > 1 ? nameParts[1] : ""; 
        const email = user.email;
        const phoneNumber = user.phoneNumber ? user.phoneNumber : "";
        const uid = user.uid;
        const driverId = createDriverId(firstName, lastName);

        // Check if the user exists already
        const docSnapshot = await db.collection('users').doc(uid).get();

        if (!docSnapshot.exists) {
          await db.collection('users').doc(uid).set({
            email: email,
            firstName: firstName,
            lastName: lastName,
            driverId: driverId,
            phoneNumber: phoneNumber,
            role: 'user' 
          });

          document.getElementById('message').textContent = "Zarejestrowano pomyślnie! Przekierowanie na stronę logowania...";
          setTimeout(function() { window.location.href = '/log-in'; }, 3000);
        } else {
          document.getElementById('message').textContent = "Już jesteś zarejestrowany! Przekierowanie na stronę logowania...";
          setTimeout(function() { window.location.href = '/log-in'; }, 3000); 
        }
      })
      .catch((error) => {
        console.error('Error signing up with Google:', error);
        document.getElementById('message').textContent = "Błąd podczas rejestracji: " + error.message;
      });
    });
    </script>
    
    <style>
body {
    font-family: 'Poppins', sans-serif;
    font-weight: 400;
}

#rent-cars-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

#rent-cars-table thead {
    background-color: #64cc98;
    color: #121212;
    font-weight: 400;
}

#rent-cars-table thead th {
    padding: 10px;
    text-align: left;
    border: none;
    font-weight: 400;
}

#rent-cars-table thead th:first-child {
    border-top-left-radius: 10px;
}

#rent-cars-table thead th:last-child {
    border-top-right-radius: 10px;
}

#rent-cars-table tbody td {
    padding: 10px;
    border: 1px solid #ddd;
}

#rent-cars-table tbody tr:last-child td:first-child {
    border-bottom-left-radius: 10px;
}

#rent-cars-table tbody tr:last-child td:last-child {
    border-bottom-right-radius: 10px;
}

#rent-cars-table tbody tr:nth-child(even) {
    background-color: #f2f2f2;
}

#rent-cars-table tbody tr:hover {
    background-color: #ddd;
}

#rent-cars-table tbody .action-button {
    font-weight: 400;
    color: #fff;
    background-color: #64cc98;
    border: none;
    padding: 5px 20px;
    border-radius: 20px;
    cursor: pointer;
    text-decoration: none;
}

#rent-cars-table tbody .action-button:hover {
    background-color: #53b384;
}

</style>