<button id=open-popup-btn>Open Invoice Form</button><div class=popup id=invoice-popup><div class=form-container><form id=invoice-form><div class=input-group><label for=numer-faktury class=input-group>Numer Faktury:</label><input id=numer-faktury name=numer-faktury class=input-group><br></div><div class=input-group><label for=purchase-date>Data zakupu:</label><input type=date id=purchase-date name=purchase-date><br></div><div class=input-group><label for=type>Wybierz typ:</label><select id=type name=type><option value=faktura>Faktura</option><option value=paragon>Paragon z NIPem</option></select><br></div><div id=registration-number-container style=display:none><div class=input-group><label for=registration-number class=full-width>Numer rejestracyjny auta:</label><input id=registration-number name=registration-number class=full-width><br></div></div><div class=input-group><label for=nip-seller>NIP Sprzedawcy:</label><input type=number id=nip-seller name=nip-seller><br><label for=expense-category>Kategoria:</label><select id=expense-category name=expense-category><option value="" disabled=disabled selected=selected>Wybierz kategorię</option><option value=fuel>Paliwo</option><option value=repair>Naprawa i konserwacja</option><option value=parking>Parking</option><option value=training>Szkolenie i licencje</option><option value=equipment>Sprzęt i akcesoria</option><option value=other>Inne</option></select><br></div><div id=fuel-fields style=display:none><div class=input-group></div><label for=fuel-type>Rodzaj paliwa:</label><select id=fuel-type name=fuel-type><option value=paliwo>Diesel</option><option value=benzyna>Benzyna</option><option value=lpg>LPG</option></select></div><br><div class=input-group><label for=liters>Litry:</label><input type=number id=liters name=liters step=0.01><br></div></form></div><div class=input-group><label for=gross-amount class=full-width>Kwota brutto:</label><input type=number id=gross-amount name=gross-amount step=0.01 class=full-width><br></div><div class=input-group><label for=vat-rate>Stawka VAT:</label><br><select id=vat-rate name=vat-rate><option value=0.00>Wybierz stawkę VAT</option><option value=0.08>8%</option><option value=0.23>23%</option></select><br><label for=vat-amount>Kwota VAT:</label><br><input type=number id=vat-amount name=vat-amount readonly=readonly><br></div><div class=input-group><label for=vat-return-vat>VAT Do zwrotu:</label><br><input type=number id=vat-return-vat name=vat-return-vat readonly=readonly><br><label for=net-amount>Kwota Netto:</label><br><input type=number id=net-amount name=net-amount step=0.01 readonly=readonly><br></div><label for=invoice-file class=full-width>Skan/Zdjęcie faktury/paragonu:</label><input type=file id=invoice-file accept=.pdf,.doc,.docx,.jpg,.jpeg,.png capture=camera class=full-width><p id=file-upload-status></p><input type=submit value="Wyślij fakturę"><button id=close-popup-btn>Close</button></div><style>.form-container{background-color:#fff;padding:20px;border-radius:8px;width:90%;max-width:500px;max-height:80vh}input[type=date],input[type=file],input[type=number],input[type=text],select{width:calc(100% - 20px);padding:10px;margin-bottom:10px;margin-top:5px;border-radius:4px;border:1px solid #ddd;font-size:16px}input[type=submit]{background-color:#4caf50;border:none;color:#fff;padding:15px 32px;text-align:center;text-decoration:none;display:inline-block;font-size:16px;margin:4px 2px;transition-duration:.4s;cursor:pointer;border-radius:4px}input[type=submit]:hover{background-color:#fff;color:#000;border:1px solid #4caf50}label{font-size:16px}.popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;padding:2% 2% 0 2%}.popup.show{display:flex}.input-group{display:flex;flex-wrap:wrap;justify-content:space-between}.input-group input,.input-group label,.input-group select{width:48%}.full-width{width:100%}#close-popup-btn,input[type=submit]{width:100%;border-radius:20px;padding:12px}input[type=submit]{background-color:#00117c;color:#fff;border:none}#close-popup-btn{background-color:#f44336;color:#fff;border:none}input[type=submit]:hover{background-color:#45a049}#close-popup-btn:hover{background-color:#d32f2f}@media only screen and (max-width:600px){.form-container{width:96%;overflow-y:auto;max-height:80vh;margin-top:10%;margin-bottom:10%}input[type=date],input[type=file],input[type=number],input[type=submit],input[type=text],label,select{font-size:14px}input[type=date],input[type=file],input[type=number],input[type=text],select{padding:8px}input[type=submit]{padding:12px}}#close-popup-btn{background-color:#f44336;color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;transition-duration:.4s}#close-popup-btn:hover{background-color:#fff;color:#f44336;border:1px solid #f44336}</style><script>document.addEventListener("DOMContentLoaded",e=>{function t(){var e=parseFloat(document.getElementById("gross-amount").value),t=parseFloat(document.getElementById("vat-rate").value),e=e*t/(1+t);document.getElementById("vat-amount").value=e.toFixed(2),document.getElementById("vat-return-vat").value=(.5*e).toFixed(2)}function n(){var e=parseFloat(document.getElementById("gross-amount").value),t=parseFloat(document.getElementById("vat-rate").value);document.getElementById("net-amount").value=(e/(1+t)).toFixed(2)}function o(r,i){firebase.auth().onAuthStateChanged(e=>{e&&(e=firebase.auth().currentUser.uid,firebase.firestore().collection("users").doc(e).get().then(u=>{if(u.exists){let t=u.data().driverId,e=new Date,n=e.getDate()-e.getDay()+(0===e.getDay()?-6:1),o=new Date(e.setDate(n)),a=`${o.getFullYear()}-${o.getMonth()+1}-`+o.getDate(),d=document.getElementById("numer-faktury").value,l=(d=d.replace(/ /g,"_").replace(/\W/g,""),firebase.storage().ref(`invoices/${t}/${a}/`+d).put(r));l.on(firebase.storage.TaskEvent.STATE_CHANGED,function(e){},function(e){console.error(e)},function(){console.log("File uploaded successfully"),l.snapshot.ref.getDownloadURL().then(function(e){console.log("File available at",e),i.fileURL=e,realtimeDb.ref().child(`drivers/${t}/invoices`).push(i),document.getElementById("invoice-form").reset(),alert("Faktura została pomyślnie dodana. Możesz dodać kolejną fakturę!"),document.getElementById("invoice-popup").classList.remove("show"),document.getElementById("invoice-form").reset()})})}else console.log("No such document!")}).catch(e=>{console.log("Error getting document:",e)}))})}document.getElementById("open-popup-btn").addEventListener("click",function(){document.getElementById("invoice-popup").classList.add("show")}),document.getElementById("close-popup-btn").addEventListener("click",function(){document.getElementById("invoice-popup").classList.remove("show"),document.getElementById("invoice-form").reset()}),document.getElementById("gross-amount").addEventListener("input",t),document.getElementById("vat-rate").addEventListener("change",t),document.getElementById("gross-amount").addEventListener("input",n),document.getElementById("vat-rate").addEventListener("change",n),document.getElementById("net-amount").addEventListener("input",t),document.getElementById("vat-rate").addEventListener("change",t),document.getElementById("type").addEventListener("change",function(){"paragon"===this.value?document.getElementById("registration-number-container").style.display="block":document.getElementById("registration-number-container").style.display="none"}),document.getElementById("net-amount").addEventListener("input",n),document.getElementById("vat-rate").addEventListener("change",n),document.getElementById("invoice-form").addEventListener("submit",function(e){e.preventDefault();e=document.querySelectorAll("#invoice-form input");if(e)if(Array.prototype.every.call(e,function(e){return"liters"===e.id||"fuel-type"===e.id||"registration-number"===e.id&&"paragon"!==document.getElementById("type").value||""!==e.value})){let t={numerfaktury:document.getElementById("numer-faktury").value,purchaseDate:document.getElementById("purchase-date").value,type:document.getElementById("type").value,nipseller:document.getElementById("nip-seller").value,fuelType:document.getElementById("fuel-type").value,grossAmount:document.getElementById("gross-amount").value,vatRate:document.getElementById("vat-rate").value,netAmount:document.getElementById("net-amount").value,vatAmount:document.getElementById("vat-amount").value,vatReturn:document.getElementById("vat-return-vat").value,status:"w trakcie sprawdzenia"},n=(t.registrationNumber="paragon"===t.type?document.getElementById("registration-number").value:"Nie dotyczy",document.getElementById("invoice-file").files[0]);n?imageCompression(n,{maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0}).then(function(e){console.log("compressedFile instanceof Blob",e instanceof Blob),console.log(`compressedFile size ${e.size/1024/1024} MB`),o(n=e,t)}).catch(function(e){console.log(e.message)}):o(n,t)}else alert("Proszę wypełnić wszystkie pola.");else console.log("No input elements found in the form.")}),document.getElementById("expense-category").addEventListener("change",function(){"fuel"===this.value?(document.getElementById("fuel-fields").style.display="block",document.getElementById("liters").required=!0):(document.getElementById("fuel-fields").style.display="none",document.getElementById("liters").required=!1)})})</script>