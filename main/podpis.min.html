<div id=step_4 class=step><h2>Przeglądaj i podpisuj dokumenty:</h2><p>Prosimy o zapoznanie się z poniższymi dokumentami i podpisanie ich.</p><div id=documents-list><div class=document-item data-contract-id=regulamin data-generate-function=regulamin><h3>Regulamin</h3><p class=generation-message style=display:none>Generowanie dokumentu...</p><div class=progress-container style=display:none><div class=progress-bar></div></div><button onclick=requestDocumentGeneration(this)>Generuj i otwórz</button></div><div class=document-item data-contract-id=zasadyWspolpracy data-generate-function=zasadyWspolpracy><h3>Zasady Współpracy</h3><p class=generation-message style=display:none>Generowanie dokumentu...</p><div class=progress-container style=display:none><div class=progress-bar></div></div><button onclick=requestDocumentGeneration(this)>Generuj i otwórz</button></div><div class=document-item data-contract-id=rodo data-generate-function=rodo><h3>Rodo</h3><p class=generation-message style=display:none>Generowanie dokumentu...</p><div class=progress-container style=display:none><div class=progress-bar></div></div><button onclick=requestDocumentGeneration(this)>Generuj i otwórz</button></div></div><button id=next_step_4>Dalej</button><p id=error_step_4 style=color:red></p></div><div id=document-modal style=display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4)><div style="background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:70%"><iframe id=document-frame width=100% height=500px></iframe><button id=openSignatureModal onclick=openSignatureModal()>Podpisz</button></div></div><div id=signature-modal style=display:none;position:fixed;z-index:2;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4)><div style="background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:70%"><canvas id=signature-pad-modal width=400 height=200 style="border:1px solid #000"></canvas><button id=signButtonModal onclick=saveSignature() style=display:none>Zatwierdź podpis</button><button onclick=closeSignatureModal()>Zamknij</button><button onclick=clearSignature()>Wyczyścić</button></div></div><div id=thank_you><h1>Dziękujemy!</h1><p>Twoje informacje zostały pomyślnie wysłane. Za chwilę zostaniesz przekierowany na portal.</p></div><div id=progress-container style=width:100%;background-color:#ccc;margin-bottom:20px><div id=progress-bar style=width:0%;height:20px;background-color:#4caf50></div></div><style>#document-modal{font-size:16px}#document-modal>div{width:95%;max-width:800px;margin:5% auto;overflow-y:auto}#signature-pad{width:100%;max-width:600px;height:300px;margin:20px auto;border:1px solid #000;background-color:#fff}.progress-container{width:100%;background-color:#ccc;margin-bottom:10px}.progress-bar{width:0%;height:20px;background-color:#4caf50;transition:width .5s}</style><script>async function getDriverId(){if(!currentUserId)return null;try{var e=await db.collection("users").doc(currentUserId).get();return e.exists?e.data().driverId:(console.error("User document does not exist."),null)}catch(e){return console.error("Error fetching user data:",e),null}}async function requestDocumentGeneration(e,t=!0){var e=e.parentElement,n=e.getAttribute("data-generate-function"),o=e.querySelector(".progress-bar"),r=e.querySelector(".progress-container"),c=e.querySelector(".generation-message");c.style.display="block",r.style.display="block";let a=0;const s=setInterval(()=>{a<100?(a+=10,o.style.width=a+"%"):clearInterval(s)},200);console.log("Generated document type:",n);var i=e.getAttribute("data-contract-id"),e=await getDriverId();e?fetch("https://us-central1-ccmcolorpartner.cloudfunctions.net/generateDocument",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({driverName:e,documentType:n})}).then(e=>e.json()).then(e=>{c.style.display="none",r.style.display="none",clearInterval(s),t&&openDocument(e.pdfUrl,i)}).catch(e=>{console.error("Error during document generation:",e),document.getElementById("error_step_4").textContent="Błąd podczas generowania dokumentu."}):console.error("Unable to get driverId.")}async function checkIfDocumentIsSigned(e,t){try{var n=await db.collection("users").doc(e).collection("dokumenty").doc(t).get();return n.exists&&n.data().signed}catch(e){return console.error("Error checking document signature:",e),!1}}async function updateDocumentButtons(){for(const n of["regulamin","zasadyWspolpracy","rodo"]){var e=await checkIfDocumentIsSigned(currentUserId,n),t=document.querySelector(`.document-item[data-contract-id="${n}"] button`);e?(t.textContent="Dokument podpisany",t.disabled=!0):(t.textContent="Generuj i otwórz",t.disabled=!1)}}function showGenerationProgress(){document.getElementById("documents-progress").style.display="block"}function hideGenerationProgress(){document.getElementById("documents-progress").style.display="none"}function openDocument(e,t){var n=document.getElementById("document-frame"),o=document.getElementById("signButton");n.src=e,currentContractId=t,o.style.display="block",document.getElementById("document-modal").style.display="block",o.textContent="Zatwierdź podpis",o.disabled=!1}function isInsideCanvas(e){let t,n;n=(e.touches?(t=e.touches[0].clientX,e.touches[0]):(t=e.clientX,e)).clientY;e=canvas.getBoundingClientRect();return t>=e.left&&t<=e.right&&n>=e.top&&n<=e.bottom}let canvas=document.getElementById("signature-pad"),ctx=canvas.getContext("2d"),drawing=!1,emptySignatureData;function draw(e){var t;drawing&&(ctx.lineWidth=5,ctx.lineCap="round",ctx.strokeStyle="black",t=canvas.getBoundingClientRect(),ctx.lineTo(e.clientX-t.left,e.clientY-t.top),ctx.stroke(),ctx.beginPath(),ctx.moveTo(e.clientX-canvas.offsetLeft,e.clientY-canvas.offsetTop))}async function checkIfDocumentIsSigned(e,t){try{var n=await db.collection("users").doc(e).collection("dokumenty").doc(t).get();return n.exists&&n.data().signature}catch(e){return console.error("Error checking document signature:",e),!1}}async function saveSignature(){var e=canvas.toDataURL(),t=currentContractId;if(e===emptySignatureData)console.error("No signature detected. Please sign before saving.");else{var n=atob(e.split(",")[1]),o=[];for(let e=0;e<n.length;e+=512){var r=n.slice(e,e+512),c=new Array(r.length);for(let e=0;e<r.length;e++)c[e]=r.charCodeAt(e);var a=new Uint8Array(c);o.push(a)}var e=new Blob(o,{type:"image/png"}),s=firebase.storage().ref().child(`signatures/${currentUserId}/${t}.png`);try{await s.put(e);var i=await s.getDownloadURL(),d=(await db.collection("users").doc(currentUserId).collection("dokumenty").doc(t).set({signature:i}),console.log("Signature saved successfully."),document.getElementById("signButton")),l=(d.textContent="Dokument podpisany",d.disabled=!0,clearSignature(),document.querySelector(`[data-contract-id="${t}"] button`));requestDocumentGeneration(l,!1),closeDocumentModal()}catch(e){console.error("Error saving signature:",e)}await updateDocumentButtons()}}function clearSignature(){ctx.clearRect(0,0,canvas.width,canvas.height),drawing=!1}function closeDocumentModal(){document.getElementById("document-modal").style.display="none"}async function areAllDocumentsSigned(){for(const e of["regulamin","zasadyWspolpracy","rodo"])if(!await checkIfDocumentIsSigned(currentUserId,e))return!1;return!0}function disableScrolling(){let e=window.scrollX,t=window.scrollY;window.onscroll=function(){window.scrollTo(e,t)}}function enableScrolling(){window.onscroll=function(){}}window.onload=function(){emptySignatureData=canvas.toDataURL()},canvas.addEventListener("mousedown",function(){drawing=!0,ctx.beginPath()}),canvas.addEventListener("mousemove",function(e){isInsideCanvas(e)?draw(e):drawing=!1}),canvas.addEventListener("touchstart",function(e){e.preventDefault(),drawing=!0,ctx.beginPath();var t=canvas.getBoundingClientRect();ctx.moveTo(e.touches[0].clientX-t.left,e.touches[0].clientY-t.top)}),canvas.addEventListener("touchmove",function(e){var t;e.preventDefault(),isInsideCanvas(e)?drawing&&(ctx.lineWidth=5,ctx.lineCap="round",ctx.strokeStyle="black",t=canvas.getBoundingClientRect(),ctx.lineTo(e.touches[0].clientX-t.left,e.touches[0].clientY-t.top),ctx.stroke()):drawing=!1}),canvas.addEventListener("touchend",function(e){e.preventDefault(),drawing=!1})</script>