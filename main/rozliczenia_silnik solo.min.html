<form id=upload-form><label for=uber-file>Załaduj Uber CSV:</label><input type=file id=uber-file data-service=uber accept=.csv><label for=bolt-file>Załaduj Bolt CSV:</label><input type=file id=bolt-file data-service=bolt accept=.csv><label for=freenow-file>Załaduj Freenow CSV:</label><input type=file id=freenow-file data-service=freenow accept=.csv><label for=city>City:</label><select id=city name=city><option value=warsaw>Warssaw</option><option value=krakow>Krakow</option><option value=wroclaw>Wroclaw</option><option value=poznan>Poznan</option><option value=gdansk>Gdansk</option><option value=szczecin>Szczecin</option><option value=lodz>Lodz</option><option value=lublin>Lublin</option><option value=katowice>Katowice</option><option value=bialystok>Bialystok</option><option value=gdynia>Gdynia</option><option value=Rzeszów>Rzeszów</option><option value=Kalisz>Kalisz</option><option value=Kielce>Kielce</option><option value=Sopot>Sopot</option><option value=Trójmiasto>Trójmiasto</option><option value=Opole>Opole</option><option value=Gorzow_Wielkopolski>Gorzów Wielkopolski</option><option value=Białystok>Białystok</option><option value=Bielsko_Biała>Bielsko Biała</option><option value=trojmiasto>Trójmiasto</option><option value=Olsztyn>Olsztyn</option><option value=Lublin>Lublin</option><option value=Słupsk>Słupsk</option></select><label for=start-date>Początek okresu rozliczeniowego:</label><input type=date id=start-date name=start-date><label for=end-date>Koniec okresu rozliczeniowego:</label><input type=date id=end-date name=end-date><label for=week>Tydzień:</label><input id=week name=week readonly=readonly><button type=submit>Rozlicz</button></form><script src=https://code.jquery.com/jquery-3.6.0.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js></script><script src=https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js></script><script src=https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js></script><script src=https://www.gstatic.com/firebasejs/8.6.1/firebase-storage.js></script><script>const firebaseConfig={apiKey:"AIzaSyDVz0ho0nQb7Sh9o_0wFLZfVJM7aeGYgb0",authDomain:"ccmcolorpartner.firebaseapp.com",databaseURL:"https://ccmcolorpartner-default-rtdb.europe-west1.firebasedatabase.app",projectId:"ccmcolorpartner",storageBucket:"ccmcolorpartner.appspot.com",messagingSenderId:"417966588632",appId:"1:417966588632:web:bf85b1ff7307bb86de8dad",measurementId:"G-WQP6RE6CQ3"},auth=(firebase.initializeApp(firebaseConfig),console.log(firebaseConfig),firebase.auth()),db=firebase.firestore(),firestoreDb=db,realtimeDb=firebase.database();function loginUser(e,o){auth.signInWithEmailAndPassword(e,o).then(e=>{console.log("Пользователь вошел в систему:",e.user),console.log("User UID:",e.user.uid)}).catch(e=>{console.error("Ошибка входа:",e),console.error("Error code:",e.code),console.error("Error message:",e.message)})}function formatNumber(e,o=2){return"number"==typeof e?parseFloat(e.toFixed(o)):e}auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL),auth.onAuthStateChanged(e=>{e?console.log("User signed in:",e):console.log("Пользователь вышел")}),window.addEventListener("DOMContentLoaded",e=>{var o=document.getElementById("login-form"),o=(o&&o.addEventListener("submit",e=>{e.preventDefault();var e=document.getElementById("email-input").value,o=document.getElementById("password-input").value;console.log("Email:",e),console.log("Password:",o),loginUser(e,o)}),document.getElementById("logout-button"));o&&(o.onclick=function(){auth.signOut().then(()=>{console.log("User signed out successfully.")}).catch(e=>{console.error("Error signing out:",e)})})})</script><script>let combinedDataByDriver={},e={uber:[],bolt:[],freenow:[]},t=[];function handleFileUploadAndCalculation(e){var a=e.target.getAttribute("data-service");e.preventDefault();let t=$(e.target),o=a,n=t.find('input[name="week"]').val();!n||isNaN(n)?alert("VALID FILE OK"):(r=parseInt(n),e.target.files&&0!==e.target.files.length&&((a=e.target.files[0])&&a.name.toLowerCase().endsWith(".csv")?((e=new FileReader).onload=function(e){let a=e.target.result,t;if(o&&"bolt"===o.toLowerCase())t=processBoltData(a,r);else if(o&&"uber"===o.toLowerCase())t=processUberData(a,r);else{if(!o||"freenow"!==o.toLowerCase())return;t=processFreenowData(a,r)}mergeDriverData(o,t),driverSummary[o]=t,mergeDriverData(o,t)},e.readAsText(a)):alert("Invalid file format. Please upload a CSV file.")))}async function readCSVFile(r){return new Promise((a,t)=>{var e=new FileReader;e.onload=e=>{a(e.target.result)},e.onerror=e=>{t(e)},e.readAsText(r)})}function processAllFiles(e,a,t,r){e=processUberData(e,r),a=processBoltData(a,r),t=processFreenowData(t,r);Object.assign(combinedDataByDriver,e,a,t)}function replacePolishChars(e){let a={"ą":"a","ć":"c","ę":"e","ł":"l","ń":"n","ó":"o","ś":"s","ź":"z","ż":"z","Ą":"A","Ć":"C","Ę":"E","Ł":"L","Ń":"N","Ó":"O","Ś":"S","Ź":"Z","Ż":"Z"};return e.replace(/[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g,e=>a[e])}function processBoltData(e,a){return processData("bolt",e,updateBoltDriverData,e=>replacePolishChars(e.Kierowca),a,e=>!Object.values(e).some(e=>"Wszyscy kierowcy"===e))}function processUberData(e,a){return processData("uber",e,updateUberDriverData,e=>replacePolishChars(e["Imię kierowcy"].split(" ")[0])+" "+replacePolishChars(e["Nazwisko kierowcy"].split(" ")[0].split("-")[0]),a)}function processFreenowData(e,a){return processData("freenow",e,updateFreenowDriverData,e=>replacePolishChars(e.Driver),a)}function processData(e,a,t,r,o,n){var i,a=Papa.parse(a,{header:!0,skipEmptyLines:!0}),l={},d=a.meta.fields;console.log("Headers from CSV:",d);for(i of a.data)if(!n||n(i)){var s="function"==typeof r?r(i):i[r];if(!s)break;s=capitalizeWords(s);l[s]||(l[s]={driver_id:s,week:o,kursy:0,przychod_dodatkowy:0,commission:0,gotowka:0,tips:0,vat_przejazdy:0,vat_dodatkowy:0,vat_bonus:0,partner:0,zus:0,wynajem:0,total:0}),t(l[s],i)}}function capitalizeWords(e){return e.toLowerCase().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}function parseFloatOrDefault(e){e=e?parseFloat(e.replace(",",".")):0;return isNaN(e)?0:e}function updateBoltDriverData(e,a){var t=parseFloatOrDefault(a["Wartość brutto"]);t&&(e.kursy+=t,e.przychod_dodatkowy+=parseFloatOrDefault(a["Opłata za anulowanie"])+parseFloatOrDefault(a.Zwroty)+parseFloatOrDefault(a.Rekompensaty)+parseFloatOrDefault(a["Opłata drogowa"])+parseFloatOrDefault(a.Bonus)+ +parseFloatOrDefault(a.Napiwek),e.commission+=parseFloatOrDefault(a["Opłata Bolt"]),e.gotowka+=parseFloatOrDefault(a["Przejazdy gotówkowe (przyjęta gotówka)"]),e.vat_przejazdy=-.08*e.kursy,e.vat_dodatkowy=-.23*e.przychod_dodatkowy,e.total=e.kursy+e.przychod_dodatkowy+e.commission+e.gotowka+e.vat_przejazdy+e.vat_dodatkowy,mergeDriverData("bolt",[e]),saveDataToFirebase(e.driver_id,e.week,"bolt",e))}function updateUberDriverData(e,a){console.log("Received data:",a);var t,r=parseFloatOrDefault(a["Wypłacono Ci : Twój przychód"]);if(console.log("Wypłacono Ci : Twój przychód:",a["Wypłacono Ci : Twój przychód"]),r){e.kursy+=r;for(t of["Wypłacono Ci:Twój przychód:Opłata:Korekta","Wypłacono Ci:Twój przychód:Opłata:UberX Priority","Wypłacono Ci:Twój przychód:Opłata:Czas oczekiwania w miejscu odbioru","Wypłacono Ci:Twój przychód:Promocja:Program Quest","Wypłacono Ci:Twój przychód:Napiwek","Wypłacono Ci:Twój przychód:Opłata:Mnożnik","Wypłacono Ci:Twój przychód:Opłata:Odwołanie"])console.log(t+":",a[t]),e.przychod_dodatkowy+=parseFloatOrDefault(a[t]);e.commission=0,console.log("Wypłacono Ci : Bilans przejazdu : Wypłaty : Odebrana gotówka:",a["Wypłacono Ci : Bilans przejazdu : Wypłaty : Odebrana gotówka"]),console.log("Wypłacono Ci:Bilans przejazdu:Zwroty:Opłata lotniskowa:",a["Wypłacono Ci:Bilans przejazdu:Zwroty:Opłata lotniskowa"]),e.gotowka+=parseFloatOrDefault(a["Wypłacono Ci : Bilans przejazdu : Wypłaty : Odebrana gotówka"])+parseFloatOrDefault(a["Wypłacono Ci:Bilans przejazdu:Zwroty:Opłata lotniskowa"]),e.vat_przejazdy=-.08*e.kursy,e.vat_dodatkowy=-.23*e.przychod_dodatkowy,e.total=e.kursy+e.przychod_dodatkowy+e.commission+e.gotowka+e.vat_przejazdy+e.vat_dodatkowy,mergeDriverData("uber",[e]),saveDataToFirebase(e.driver_id,e.week,"uber",e)}}function updateFreenowDriverData(e,a){var t=parseFloatOrDefault(a["Completed trips "]);t&&(e.kursy+=t,e.przychod_dodatkowy+=parseFloatOrDefault(a.Incentives)+parseFloatOrDefault(a.Tolls)+parseFloatOrDefault(a.Cancellations)+parseFloatOrDefault(a["Waiting time"])+parseFloatOrDefault(a.Tips)+parseFloatOrDefault(a["Airport fee"])+parseFloatOrDefault(a["Hotel fee"]),e.commission=-parseFloatOrDefault(a.Commission)+parseFloatOrDefault(a.Others),e.gotowka-=parseFloatOrDefault(a["Non-app payments"]),e.vat_przejazdy=-.08*e.kursy,e.vat_dodatkowy=-.23*e.przychod_dodatkowy,e.total=e.kursy+e.przychod_dodatkowy+e.commission+e.gotowka+e.vat_przejazdy+e.vat_dodatkowy,mergeDriverData("freenow",[e]),saveDataToFirebase(e.driver_id,e.week,"freenow",e))}function calculateDriverData(e){var a={...e};return a.vat_przejazdy=.08*e.kursy,a.vat_dodatkowy=.23*e.przychod_dodatkowy,"Uczeń/Student"==e.workStatus?(a.zus=0,a.podatek_do_zaplaty=0):"Osoba do 26 roku życia"==e.workStatus&&(a.zus=0),a}function saveDataToFirebase(e,a,t,r){realtimeDb.ref(`drivers/${e}/weeks/${a}/apps/${t}/`).update(r)}function mergeDriverData(p,e,a,t){console.log("mergeDriverData function started");let r=[];e.forEach(c=>{console.log("Processing driver: "+JSON.stringify(c));let u=c.driver_id,e=realtimeDb.ref("drivers/"+u).get().then(e=>{console.log("Got driver data from realtimeDb"),calculateDriverData(e.val());let a=e.val().zusType,t=e.val().car;return Promise.all([realtimeDb.ref("admin/carsrent/"+t).get(),realtimeDb.ref("admin/"+a).get()]).then(([e,a])=>{console.log("Got carRentData and zusData");let d,s=(e.exists()&&e.val()?d=parseFloat(e.val().rent):(d=0,t?console.log("No rent data found for car: "+t):console.log("Car data not found for driver: "+u)),Number(a.val()));return realtimeDb.ref("admin/partner").get().then(e=>{console.log("Got partnerData");let l=Number(e.val());return realtimeDb.ref(`drivers/${u}/invoices`).get().then(e=>{let a=e.val(),t=0,r=0,o=0;e=new Date,e=5<=e.getDate()&&e.getDate()<=11;console.log("ZUS value:",s),console.log("Should deduct ZUS:",e);let n=new Date(document.getElementById("start-date").value),i=new Date(document.getElementById("end-date").value);a?Object.values(a).forEach(e=>{var a=new Date(e.purchaseDate+"T00:00:00");e&&"zaakceptowany"===e.status&&a>=n&&a<=i&&("wydatek"===e.type?(console.log("Accepted wydatek: "+JSON.stringify(e)),r+=Number(e.grossAmount||0)):"faktura"===e.type&&(o+=Number(e.grossAmount||0),t+=Number(e.vatReturn||0)))}):(t=0,costsReturn=0),combinedDataByDriver[u]?(combinedDataByDriver[u].service||(combinedDataByDriver[u].service=[]),combinedDataByDriver[u].service.includes(p)||combinedDataByDriver[u].service.push(p),Object.keys(c).forEach(e=>{-1===["driver_id","week","service"].indexOf(e)&&(combinedDataByDriver[u][e]+=c[e])})):(combinedDataByDriver[u]={driver_id:u,week:c.week,service:[p],...c},combinedDataByDriver[u].kursy=c.kursy,combinedDataByDriver[u].przychod_dodatkowy=c.przychod_dodatkowy,combinedDataByDriver[u].commission=c.commission,combinedDataByDriver[u].gotowka=c.gotowka,combinedDataByDriver[u].vat_przejazdy=c.vat_przejazdy,combinedDataByDriver[u].vat_dodatkowy=c.vat_dodatkowy,combinedDataByDriver[u].vat_bonus=t,combinedDataByDriver[u].partner=l,combinedDataByDriver[u].zus=e?s:0,combinedDataByDriver[u].wynajem=d,combinedDataByDriver[u].inne=r,combinedDataByDriver[u].zwrot_kosztow=o,combinedDataByDriver[u].total=c.total+t-d-(e?s:0)-l-r),combinedDataByDriver[u]}).catch(e=>{console.error("Error while getting invoices: "+e),console.log(`Current calculations: Expenses: ${expensesValue}, Invoices: ${invoiceValue}, VAT Return: `+vatReturn)})}).catch(e=>{console.error("Error while getting partner value: "+e)})}).catch(e=>{console.error("Error while getting rent per week or zus value: "+e)})}).catch(e=>{console.error("Error while getting driver data: "+e)});r.push(e)}),Promise.all(r).then(()=>{console.log("All promises successfully resolved."),saveCombinedDataToFirebase()}).catch(e=>{console.error("An error occurred: "+e)})}function saveCombinedDataToFirebase(){let i=[],l=document.getElementById("city").value;return Object.values(combinedDataByDriver).forEach(e=>{let a=e.driver_id,t=e.week,r=document.getElementById("start-date").value,o=document.getElementById("end-date").value,n={kursy:e.kursy||0,przychod_dodatkowy:e.przychod_dodatkowy||0,tips:e.tips||0,commission:e.commission||0,gotowka:e.gotowka||0,vat_przejazdy:e.vat_przejazdy||0,vat_dodatkowy:e.vat_dodatkowy||0,vat_bonus:e.vat_bonus||0,partner:e.partner||0,zus:e.zus||0,inne:e.inne||0,wynajem:e.wynajem||0,zwrot_kosztow:e.zwrot_kosztow||0,total:e.total||0,service:e.service||[],startDate:r,endDate:o,city:l,status:"123"};e=realtimeDb.ref(`drivers/${a}/weeks/${t}/summary`).update(n).catch(e=>{console.error(`Error while updating balance for driver ${a}: `+e)});i.push(e)}),Promise.all(i)}function updateWeekNumber(){var e=new Date(document.getElementById("start-date").value),a=new Date(document.getElementById("end-date").value),e=getWeekNumber(e),a=getWeekNumber(a);document.getElementById("week").value=e===a?e:e+"-"+a}function getWeekNumber(e){(e=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()))).setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));var a=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-a)/864e5+1)/7)}dataAdded=!(drivers={}),document.getElementById("uber-file").addEventListener("change",handleFileUploadAndCalculation),document.getElementById("bolt-file").addEventListener("change",handleFileUploadAndCalculation),document.getElementById("freenow-file").addEventListener("change",handleFileUploadAndCalculation),document.getElementById("upload-form").addEventListener("submit",async e=>{e.preventDefault();e=document.getElementById("week").value;if(e){var a,t,r=document.getElementById("uber-file"),o=document.getElementById("bolt-file"),n=document.getElementById("freenow-file"),r={uber:r.files[0],bolt:o.files[0],freenow:n.files[0]},i={};for([a,t]of Object.entries(r)){if(t&&!t.name.toLowerCase().endsWith(".csv"))return void alert(`Invalid file format for ${a}. Please upload a CSV file.`);t?i[a]=await readCSVFile(t):i[a]=[]}processAllFiles(i.uber,i.bolt,i.freenow,e)}else alert("Please enter a week number")}),$(document).ready(function(){$("form").on("submit",handleFileUploadAndCalculation)});let startDateInput=document.getElementById("start-date").value,endDateInput=document.getElementById("end-date").value,start=new Date(startDateInput),end=new Date(endDateInput);function updateWeekNumber(){var e=new Date(document.getElementById("start-date").value),a=new Date(document.getElementById("end-date").value),e=getWeekNumber(e),a=getWeekNumber(a);document.getElementById("week").value=e===a?e:e+"-"+a}function getWeekNumber(e){(e=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()))).setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));var a=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-a)/864e5+1)/7)}document.getElementById("start-date").addEventListener("change",updateWeekNumber),document.getElementById("end-date").addEventListener("change",updateWeekNumber)</script>