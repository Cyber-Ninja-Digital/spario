<button id="open-popup-btn">Open Invoice Form</button>

<div class="popup" id="invoice-popup">
  <div class="form-container">
    <form id="invoice-form">
      <div class="input-group">
        <label for="numer-faktury" class="input-group">Numer Faktury:</label>
        <input type="text" id="numer-faktury" name="numer-faktury" class="input-group"><br>
      </div>
      <div class="input-group">
        <label for="purchase-date">Data zakupu:</label>
        <input type="date" id="purchase-date" name="purchase-date"><br>
      </div>
      <div class="input-group">
        <label for="type">Wybierz typ:</label>
        <select id="type" name="type">
          <option value="faktura">Faktura</option>
          <option value="paragon">Paragon z NIPem</option>
        </select><br>
      </div>
      <div id="registration-number-container" style="display: none;">
        <div class="input-group">

        <label for="registration-number" class="full-width">Numer rejestracyjny auta:</label>
        <input type="text" id="registration-number" name="registration-number" class="full-width"><br>
      </div>
    </div>
      <div class="input-group">
        <label for="nip-seller">NIP Sprzedawcy:</label>
        <input type="number" id="nip-seller" name="nip-seller"><br>
        <label for="expense-category">Kategoria:</label>
        <select id="expense-category" name="expense-category">
          <option value="" disabled selected>Wybierz kategorię</option>
          <option value="fuel">Paliwo</option>
          <option value="repair">Naprawa i konserwacja</option>
          <option value="parking">Parking</option>
          <option value="training">Szkolenie i licencje</option>
          <option value="equipment">Sprzęt i akcesoria</option>
          <option value="other">Inne</option>
        </select><br>
      </div>
      <div id="fuel-fields" style="display: none;">
        <div class="input-group"></div>
        <label for="fuel-type">Rodzaj paliwa:</label>
        <select id="fuel-type" name="fuel-type">
          <option value="paliwo">Diesel</option>
          <option value="benzyna">Benzyna</option>
          <option value="lpg">LPG</option>
        </div>

        </select><br>
        <div class="input-group">

        <label for="liters">Litry:</label>
        <input type="number" id="liters" name="liters" step="0.01"><br>
      </div>

      </div>
      <div class="input-group">
        <label for="gross-amount" class="full-width">Kwota brutto:</label>
        <input type="number" id="gross-amount" name="gross-amount" step="0.01" class="full-width"><br>
      </div>
      <div class="input-group">
        <label for="vat-rate">Stawka VAT:</label><br>
        <select id="vat-rate" name="vat-rate">
          <option value="0.00">Wybierz stawkę VAT</option>
          <option value="0.08">8%</option>
          <option value="0.23">23%</option>
        </select><br>
        <label for="vat-amount">Kwota VAT:</label><br>
        <input type="number" id="vat-amount" name="vat-amount" readonly><br>
      </div>
      <div class="input-group">
        <label for="vat-return-vat">VAT Do zwrotu:</label><br>
        <input type="number" id="vat-return-vat" name="vat-return-vat" readonly><br>
        <label for="net-amount">Kwota Netto:</label><br>
        <input type="number" id="net-amount" name="net-amount" step="0.01" readonly><br>
      </div>
      <label for="invoice-file" class="full-width">Skan/Zdjęcie faktury/paragonu:</label>
      <input type="file" id="invoice-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" capture="camera" class="full-width">
      <p id="file-upload-status"></p>
      <input type="submit" value="Wyślij fakturę">
    </form>
    <button id="close-popup-btn">Close</button>
  </div>
</div>
<style>
  .form-container {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
  }
  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="file"],
  select {
    width: calc(100% - 20px);
    padding: 10px;
    margin-bottom: 10px;
    margin-top: 5px;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-size: 16px;
  }
  input[type="submit"] {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    transition-duration: 0.4s;
    cursor: pointer;
    border-radius: 4px;
  }
  input[type="submit"]:hover {
    background-color: white;
    color: black;
    border: 1px solid #4CAF50;
  }
  label {
    font-size: 16px;
  }
  .popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    padding: 2% 2% 0 2%;
  }
  .popup.show {
    display: flex;
  }
  .input-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
  }
  .input-group label,
  .input-group select,
  .input-group input {
    width: 48%;
    /* adjust as per requirement */
  }
  .full-width {
    width: 100%;
  }
  input[type="submit"], #close-popup-btn {
    width: 100%;  /* Makes the buttons full width */
    border-radius: 20px;  /* Rounds the corners */
    padding: 12px;  /* Adds some vertical padding */
}

input[type="submit"] {
    background-color: #00117c;  /* Your green color */
    color: white;  /* White text */
    border: none;  
}

#close-popup-btn {
    background-color: #f44336;  /* Your red color */
    color: white;  /* White text */
    border: none;
}

/* Hover effects */
input[type="submit"]:hover {
    background-color: #45a049;  /* A slightly different green for a hover effect */
}

#close-popup-btn:hover {
    background-color: #d32f2f;  /* A slightly different red for a hover effect */
}

  @media only screen and (max-width: 600px) {
    .form-container {
      width: 96%;
      overflow-y: auto;
      max-height: 80vh;
      margin-top: 10%;
      margin-bottom: 10%;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="file"],
    select,
    input[type="submit"],
    label {
      font-size: 14px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="file"],
    select {
      padding: 8px;
    }
    input[type="submit"] {
      padding: 12px;
    }
  }
  #close-popup-btn {
    background-color: #f44336;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition-duration: 0.4s;
  }
  #close-popup-btn:hover {
    background-color: white;
    color: #f44336;
    border: 1px solid #f44336;
  }
</style>
<script>
  document.addEventListener("DOMContentLoaded", (e) => {
    function t() {
      let e = parseFloat(document.getElementById("gross-amount").value),
        t = parseFloat(document.getElementById("vat-rate").value),
        a = (e * t) / (1 + t);
      (document.getElementById("vat-amount").value = a.toFixed(2)), (document.getElementById("vat-return-vat").value = (0.5 * a).toFixed(2));
    }
    function a() {
      let e = parseFloat(document.getElementById("gross-amount").value),
        t = parseFloat(document.getElementById("vat-rate").value);
      document.getElementById("net-amount").value = (e / (1 + t)).toFixed(2);
    }
    function n(e, t) {
      firebase.auth().onAuthStateChanged((a) => {
        if (a) {
          let n = firebase.auth().currentUser.uid;
          firebase
            .firestore()
            .collection("users")
            .doc(n)
            .get()
            .then((a) => {
              if (a.exists) {
                let n = a.data().driverId,
                  l = new Date(),
                  i = l.getDate() - l.getDay() + (0 === l.getDay() ? -6 : 1),
                  o = new Date(l.setDate(i)),
                  u = `${o.getFullYear()}-${o.getMonth() + 1}-${o.getDate()}`,
                  d = document.getElementById("numer-faktury").value;
                d = d.replace(/ /g, "_").replace(/\W/g, "");
                let s = firebase.storage().ref(`invoices/${n}/${u}/${d}`).put(e);
                s.on(
                  firebase.storage.TaskEvent.STATE_CHANGED,
                  function (e) { },
                  function (e) {
                    console.error(e);
                  },
                  function () {
                    console.log("File uploaded successfully"),
                      s.snapshot.ref.getDownloadURL().then(function (e) {
                        console.log("File available at", e),
                          (t.fileURL = e),
                          realtimeDb.ref().child(`drivers/${n}/invoices`).push(t),
                          document.getElementById("invoice-form").reset(),
                          alert("Faktura została pomyślnie dodana. Możesz dodać kolejną fakturę!");
                          document.getElementById('invoice-popup').classList.remove('show');
        document.getElementById("invoice-form").reset();
                      });
                  }
                );
              } else console.log("No such document!");
            })
            .catch((e) => {
              console.log("Error getting document:", e);
            });
        }
      });
    }
    document.getElementById('open-popup-btn').addEventListener('click', function () {
      document.getElementById('invoice-popup').classList.add('show');
    });
    document.getElementById('close-popup-btn').addEventListener('click', function () {
      document.getElementById('invoice-popup').classList.remove('show');
      document.getElementById("invoice-form").reset();
    });
    document.getElementById("gross-amount").addEventListener("input", t),
      document.getElementById("vat-rate").addEventListener("change", t),
      document.getElementById("gross-amount").addEventListener("input", a),
      document.getElementById("vat-rate").addEventListener("change", a),
      document.getElementById("net-amount").addEventListener("input", t),
      document.getElementById("vat-rate").addEventListener("change", t),
      document.getElementById("type").addEventListener("change", function () {
        "paragon" === this.value ? (document.getElementById("registration-number-container").style.display = "block") : (document.getElementById("registration-number-container").style.display = "none");
      }),
      document.getElementById("net-amount").addEventListener("input", a),
      document.getElementById("vat-rate").addEventListener("change", a),
      document.getElementById("invoice-form").addEventListener("submit", function (e) {
        e.preventDefault();
        var areAllFieldsValid,
            inputs = document.querySelectorAll("#invoice-form input");

        if (!inputs) {
            console.log("No input elements found in the form.");
            return;
        }

        areAllFieldsValid = Array.prototype.every.call(inputs, function (input) {
            // Skip validation for 'liters' and 'fuel-type'
            if(input.id === 'liters' || input.id === 'fuel-type') {
                return true;
            }
            
            // Special condition for 'registration-number': it should be non-empty only if 'type' is 'paragon'
            if(input.id === 'registration-number') {
                return document.getElementById("type").value !== "paragon" || input.value !== "";
            }

            // For other inputs, simply check if they are non-empty
            return input.value !== "";
        });

        if (areAllFieldsValid) {
            let formData = {
                numerfaktury: document.getElementById("numer-faktury").value,
                purchaseDate: document.getElementById("purchase-date").value,
                type: document.getElementById("type").value,
                nipseller: document.getElementById("nip-seller").value,
                fuelType: document.getElementById("fuel-type").value,
                grossAmount: document.getElementById("gross-amount").value,
                vatRate: document.getElementById("vat-rate").value,
                netAmount: document.getElementById("net-amount").value,
                vatAmount: document.getElementById("vat-amount").value,
                vatReturn: document.getElementById("vat-return-vat").value,
                status: "w trakcie sprawdzenia",
            };
            formData.registrationNumber = formData.type === "paragon" 
                ? document.getElementById("registration-number").value 
                : "Nie dotyczy";
            
            let invoiceFile = document.getElementById("invoice-file").files[0];
            if (invoiceFile) {
                imageCompression(invoiceFile, { maxSizeMB: 1, maxWidthOrHeight: 1920, useWebWorker: true })
                    .then(function (compressedFile) {
                        console.log("compressedFile instanceof Blob", compressedFile instanceof Blob);
                        console.log(`compressedFile size ${compressedFile.size / 1024 / 1024} MB`);
                        n((invoiceFile = compressedFile), formData);
                    })
                    .catch(function (error) {
                        console.log(error.message);
                    });
            } else {
                n(invoiceFile, formData);
            }
        } else {
            alert("Proszę wypełnić wszystkie pola.");
        }
    });

      document.getElementById('expense-category').addEventListener('change', function () {
    // Check if the selected value is 'fuel'
    if (this.value === 'fuel') {
        // Show the fuel fields
        document.getElementById('fuel-fields').style.display = 'block';
        // Make the liters field required
        document.getElementById('liters').required = true;
    } else {
        // Hide the fuel fields
        document.getElementById('fuel-fields').style.display = 'none';
        // Make the liters field not required
        document.getElementById('liters').required = false;
    }
});
  });


</script>